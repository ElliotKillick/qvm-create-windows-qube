# qvm-create-windows-qube

qvm-create-windows-qube is a tool for quickly and conveniently installing fresh new Windows [qubes](https://www.qubes-os.org) with Qubes Windows Tools as well as other packages such as Firefox, Office 365, Notepad++ and Visual Studio pre-installed modularly and automatically.

It also benefits privacy and anominity by disabling unwanted Microsoft telemetry such as the Customer Experience Improvement Program (CEIP) and Windows Error Reporting (WER), standardizing common [Whonix](https://www.whonix.org) recommeneded defaults such as "user" for the username and "host" for the hostname, and by resetting unique identifiers present in every Windows installation such as the MachineGUID, NTFS drive Volume Serial Numbers (VSNs) and more. Note: This only affects anonymity at the OS level, however, that still leaves the hypervisor [vulnerable](https://github.com/QubesOS/qubes-issues/issues/1142) to being [fingerprinted](https://github.com/QubesOS/qubes-issues/issues/817).

## Installation

1. Download the [installation script](https://raw.githubusercontent.com/elliotkillick/qvm-create-windows-qube/master/install.sh) by right-clicking then selecting "Save as..."
2. Copy `install.sh` into Dom0 by running the following command in Dom0: `qvm-run -p --filter-escape-chars --no-color-output <qube_script_is_located_on> "cat '/home/user/Downloads/install.sh'" > install.sh`
3. Review the code of `install.sh` to ensure its integrity
4. Run `chmod +x install.sh && ./install.sh`
5. Review the code of the resulting `qvm-create-windows-qube.sh`

Important: Until this [bug](https://github.com/QubesOS/qubes-issues/issues/4684) is fixed upstream you must fix app menu syncing for HVMs (Windows, sys-net, etc.) by putting the provided `qubes-start.desktop` into `/usr/share/qubes-appmenus` in Dom0

## Usage

```
Usage: ./qvm-create-windows-qube.sh [options] <name>
  -h, --help
  -c, --count <number> Number of Windows qubes with given basename desired
  -t, --template Make this qube a TemplateVM instead of a StandaloneVM
  -n, --netvm <qube> NetVM for Windows to use (default: sys-firewall)
  -s, --seamless Enable seamless mode persistently across restarts
  -o, --optimize Optimize Windows by disabling unnecessary features for a virtual machine
  -y, --anti-spy Disable and block Windows telemetry
  -p, --packages <packages> Comma-separated list of packages to pre-install (see available packages at: https://chocolatey.org/packages)
  -i, --iso <file> Windows ISO to automatically install and setup (default: Win7_Pro_SP1_English_x64.iso)
  -a, --answer-file <xml file> Settings for Windows installation (default: windows-7.xml)
```

Example: `./qvm-create-windows-qube.sh -n sys-firewall -soyp firefox,notepadplusplus,office365business windows-7`

Note: If the Qubes GUI driver is unwanted, either due to stability issues or peformance, then that can be disabled by going into the answer file and removing everything under the RunSynchronus tag for enabling test signing. Make sure you also cause a new ISO to be generated by deleting the old \*-autounattend.iso. This works because the GUI driver is the only unsigned driver and the installer will automatically not install it if it detects test signing is disabled.

## Security

The resources qube, windows-mgmt by default, is air gapped. To mitigate the fallout of another shellshock-like Bash vulnerability, the Dom0 script communicates to the windows-mgmt qube in a one-way fashion. Downloading of the Windows ISOs are made secure by encforcing TLS 1.3/TLS 1.2 HTTPS with HTTP public key pinning (HPKP) and by verifying the SHA-256 of the files after download. Packages such as Firefox are offered out of the box so the infamously insecure Internet Explorer never has to be used.

Important: If RDP is to be enabled on the Windows qube (not default) then make sure it is fully up-to-date because the latest Windows 7 ISO Microsoft offers is unfortunately still vulnerable to BlueKeep and related DejaBlue vulnerabilites

## Contributing

You can start by giving me a star! PRs are also welcome! Take a look at the todo list below if you're looking for things that need improvement. Other improvements such as more elegant ways of completing a task, code cleanup and other fixes are also welcome.

## Todo

- [ ] Use libguestfs for a more efficient way of putting answer files into ISOs: https://rwmj.wordpress.com/2010/11/04/customizing-a-windows-7-install-iso/ (guestfish, dnf info libguestfs-tools or apt show libguestfs-tools)
    - While trying to install this package on Fedora there are many conflicts with older versions of the same packages Qubes tools relies on
    - If --allowerasing option is enabled dnf prompts to remove those Qubes packages
    - Qubes seems to be the third party repository: https://unix.stackexchange.com/questions/442064/package-x-requires-y-but-none-of-the-providers-can-be-installed
    - Installation on Debian works
- [x] auto-qwt takes D:\\ making QWT put the user profile on E:\\; it would be nicer to have it on D:\\ so there is no awkward gap in the middle
- [ ] Support Windows 8.1-10 (Note: QWT doesn't fully support Windows 10 yet)
- [ ] Support Windows Server 2008 R2 to Windows Server 2019
- [x] Provision Chocolatey (#2)
- [x] Add an option to slim down Windows as documented in: https://www.qubes-os.org/doc/windows-template-customization/
- [x] Make windows-mgmt air gapped
- [ ] Improve anti-spy option to block more Windows telemetry while being conservative to not break any Windows functionality
    - Add the IP list from [here](https://github.com/crazy-max/WindowsSpyBlocker/blob/master/data/firewall/spy.txt) to the Windows firewall
    - It only blocks IPs confirmed to be used solely for telemetry
    - Don't use the hosts file because [Windows sometimes connects directly to the IP therefore bypassing DNS resolution and the hosts file](https://www.petri.com/windows-10-ignoring-hosts-file-specific-name-resolution)
    - Not using the whole WindowsSpyBlocker project even though it's available in a Chocolatey package because by taking a look at its dependenices it seems over-engineered and we should attempt to minimize our [TCB](https://www.qubes-os.org/doc/security-critical-code/) for each Windows qube
- [ ] Put this todo list into GitHub issues
