# qvm-create-windows-qube

qvm-create-windows-qube is a tool for quickly and conveniently installing fresh new Windows [qubes](https://www.qubes-os.org) with Qubes Windows Tools as well as other packages such as Firefox, Office 365, Notepad++ and Visual Studio pre-installed modularly and automatically.

## Installation

1. Download the [installation script](https://raw.githubusercontent.com/elliotkillick/qvm-create-windows-qube/master/install.sh) by opening the link, right-clicking and then selecting "Save as..."
2. Copy `install.sh` into Dom0 by running the following command in Dom0: `qvm-run -p --filter-escape-chars --no-color-output <qube_script_is_located_on> "cat '/home/user/Downloads/install.sh'" > install.sh`
3. Review the code of `install.sh` to ensure its integrity
4. Run `chmod +x install.sh && ./install.sh`
5. Review the code of the resulting `qvm-create-windows-qube.sh`

## Usage

```
Usage: ./qvm-create-windows-qube.sh [options] <name>
  -h, --help
  -c, --count <number> Number of Windows qubes with given basename desired
  -t, --template Make this qube a TemplateVM instead of a StandaloneVM
  -n, --netvm <qube> NetVM for Windows to use
  -s, --seamless Enable seamless mode persistently across restarts
  -o, --optimize Optimize Windows by disabling unnecessary functionality for a qube
  -y, --anti-spy Disable Windows telemetry
  -p, --packages <packages> Comma-separated list of packages to pre-install (see available packages at: https://chocolatey.org/packages)
  -i, --iso <file> Windows media to automatically install and setup (default: win7x64-ultimate.iso)
  -a, --answer-file <xml file> Settings for Windows installation (default: win7x64-ultimate.xml)
```

Example: `./qvm-create-windows-qube.sh -n sys-firewall -soyp firefox,notepadplusplus,office365business win7-work`

Note: If the Qubes GUI driver is unwanted, either due to stability or peformance issues, then that can be disabled by going into the answer file and removing everything under the RunSynchronus tag for enabling test signing. Make sure you also cause a new ISO to be generated by deleting the old one in the out folder. This works because the GUI driver is the only unsigned driver and the QWT installer will automatically not install the GUI driver if it detects test signing is disabled.

## QWT Known Issues

HVMs, not QWT issue (Windows, sys-net, etc.):
    * Until this [bug](https://github.com/QubesOS/qubes-issues/issues/4684) is fixed upstream you must fix app menu syncing for HVMs (Windows, sys-net, etc.) by putting the provided `qubes-start.desktop` into `/usr/share/qubes-appmenus` in Dom0

All OSs:
    * Windows may crash on first boot after QWT is installed
        * On Windows 7, the desktop may boot back up to having no wallpaper and missing libraries. Just delete that qube and start over
        * Or it may crash during app menu creation shortly after first boot after desktop wallpaper/libraries is setup (qvm-sync-appmenus <qube_name> will fix)
        * Or it might just hang on trying to copy the post scripts over to the crashed qube
        * Fix: Just delete the qube and start over
    * In general, sometimes Windows will crash during boot
        * When trying to display screen with Qubes GUI driver it can crash during the "Welcome" loading screen that shows up or manipulating the window by resizing, mimimizing, etc. during boot (As seen when the -b/--background option existed; removed from this project because it was too unstable)
        * Happened a couple times on Windows 10 (no GUI driver of course)
    * Windows may crash on shutdown (xenbus.sys 0x0000dead BSOD)
    * Add audio support: https://github.com/QubesOS/qubes-issues/issues/2624

All OSs except Windows 7:
    * Run `qvm-features <windows_qube> gui 1` to make display show up after setup is complete
    * When Qubes GUI driver is in use, may receive a message saying Windows is trying to spoof Dom0 GUI causing installation to pause. Fix by closing window.
    * Prompt to install earlier version of .NET (However, qrexec services still seem to work): https://github.com/QubesOS/qubes-issues/issues/5091 (Waiting for this to make it into a QWT update, has been merged)
    * No GUI driver
        * This is the main priority currently for QWT: https://www.qubes-os.org/news/2016/01/27/windows-tools-open-source
        * https://github.com/QubesOS/qubes-issues/issues/1861
        * The resolution can still be increased to 1920x1080+ by increasing the display resolution in Windows

Windows 10/Windows Server 2019:
    * Private disk creation fails: https://github.com/QubesOS/qubes-issues/issues/5090
        * Temp fix: Close prepare-volume.exe window causing there to be no private disk (can't make a template VM) but besides that it will continue as normal

Windows Server 2008 R2:
    * Even the most basic QWT installation will fail and make the computer constantly boot into recovery mode
        * This is probably the same issue that occured with the very out-of-date Windows 7 ISO that was previously used
        * You must install the Servicing Stack and Convenience Rollup updates packages first as guided [here](https://www.howtogeek.com/255435/how-to-update-windows-7-all-at-once-with-microsofts-convenience-rollup)
        * You can also use the scripts used before switching to the more up-to-date Windows 7 media by doing a git checkout on commit: `e0bb3a6719f092b6bc687854f8ededb1a96e3e5f`
        * Alternatively, you can just install all updates with Windows Update and eventually that will also give you all the updates included in the aforementioned update packages (Will take a long time; some reboots)

See here:

https://github.com/QubesOS/qubes-issues/labels/C%3A%20windows-tools
https://github.com/QubesOS/qubes-issues/labels/C%3A%20windows-vm

Lots of Windows-related [GSoCs](https://www.qubes-os.org/gsoc) for those interested.

Further research is required, if you're in the giving mood please jump in and fix some of these.

## Security

The resources qube, windows-mgmt by default, is air gapped. To mitigate the fallout of another [Shellshock](https://en.wikipedia.org/wiki/Shellshock_(software_bug)) Bash vulnerability, the Dom0 script communicates to the windows-mgmt qube in a one-way fashion. Downloading of the Windows ISOs are made secure by encforcing TLS 1.2/1.3 HTTPS with HTTP public key pinning (HPKP) and by verifying the SHA-256 of the files after download. Packages such as Firefox are offered out of the box so the infamously insecure Internet Explorer never has to be used.

Windows 7/Windows Server 2008 R2 will reach [End Of Life (EOL) on January 14, 2020](https://support.microsoft.com/en-us/help/4057281/windows-7-support-will-end-on-january-14-2020). However, Office 365 for these operating systems will continue getting security updates until [January 2023](https://support.office.com/en-us/article/windows-7-end-of-support-and-office-78f20fab-b57b-44d7-8368-06a8493f3cb9).

Important: If RDP is to be enabled on the Windows qube (not default) then make sure it is fully up-to-date because the latest Windows 7 ISO Microsoft offers is unfortunately still vulnerable to [BlueKeep](https://en.wikipedia.org/wiki/BlueKeep) and related DejaBlue vulnerabilites

## Privacy

Privacy benefits by disabling unwanted Microsoft telemetry such as the Customer Experience Improvement Program (CEIP), Windows Error Reporting (WER) and Diagnostics Tracking service (DiagTrack), standardizing common Whonix recommeneded defaults such as "user" for the username and "host" for the hostname, and by resetting unique identifiers present in every Windows installation such as the MachineGUID, NTFS drive Volume Serial Numbers (VSNs) and more.

However, there are still ways to fingerprint you through the hypervisor (not specific to Windows): [lscpu](https://github.com/QubesOS/qubes-issues/issues/1142), [timezone](https://github.com/QubesOS/qubes-issues/issues/4429) (Can be mitigated by configuring UTC time in the BIOS/UEFI), screen resolution and depth, generally some of the VM interfaces documented [here](https://www.qubes-os.org/doc/vm-interface), as well as much more obscure things. Note that many of these pieces of information don't represent very many bits of uniquely identifiable information and just like Tor, as the [userbase of Qubes OS](https://www.qubes-os.org/statistics) grows, these datapoints become increasingly less significant.

## Contributing

You can start by giving this project a star! PRs are also welcome! Take a look at the todo list below if you're looking for things that need improvement. Other improvements such as more elegant ways of completing a task, code cleanup and other fixes are also welcome.

Note: This project is the product of an independent effort that is not offically endorsed by Qubes OS

## Todo

- [x] Gain the ability to reliably unpack/insert answer file/repack for any given ISO 9660 (Windows ISO format)
    - Blocking issue for supporting other versions of Windows
- [x] auto-qwt takes D:\\ making QWT put the user profile on E:\\; it would be nicer to have it on D:\\ so there is no awkward gap in the middle
- [x] Support Windows 8.1-10 (Note: QWT doesn't fully offically any OS other than Windows 7 yet, however, everything is functional except the GUI driver)
- [x] Support Windows Server 2008 R2 to Windows Server 2019
- [x] Provision Chocolatey
- [x] Add an option to slim down Windows as documented in: https://www.qubes-os.org/doc/windows-template-customization/
- [x] Make windows-mgmt air gapped
- [ ] Consider installing INF drivers in OfflineServicing pass
    - While the current way of installing them certainly works (just the QWT installer executable) it would be more proper to use this pass as this is what it's for
    - Can get around Windows 7 planned obsolescence in an offical non-hacky way (See allow-device-software.vbs)
    - Can use /ForceUnsigned option in DISM to allow Qubes GUI unsigned driver
    - We would need to parse the WIM archive format
    - For this we would use [wimlib](https://wimlib.net)
    - Seems to supports directly adding files without unpacking/repacking using [wimupdate](https://wimlib.net/man1/wimupdate.html)
    - 7-Zip also supports packing/unpacking WIM format
    - This opens a new attack surface for vulnerabilities in wimlib/7-Zip parsing which is in C (wimlib) and C++ (7-Zip); so maybe it's not worth it (However, assuming we verify the SHA-256 of the ISO then it should be okay as long as the user doesn't use their own)
    - We would definitely still have to run the QWT installation executable to setup things like the private disk
- [ ] Possibly switch from udisksctl for reading/mounting ISOs because it is written in its man page that it should not be used in scripts
    - guestfs?
    - losetup (requires sudo, but it's what's used by the Qubes core team in their scripts)
    - Consider other alternatives
- [ ] Create tool for extracting the product keys of every edition (Home, Professional, Ultimate, etc.) of Windows from any given Windows media
    - Windows Server (any edition) and Windows 7/8/10 "Enterprise Evaluation" do not need this because in these products Windows automatically uses the evaluation product key if no key is specified
    - This would replace the tedious process of getting the trial product keys of any Windows media currently in use (Read: create-media.sh)
- [ ] Upstream some issues so they can be tracked
- [ ] I recently disovered this is a Qubes [Google Summer of Code](https://www.qubes-os.org/gsoc) project; which is cool
    - Add automated tests
        - Currently using ShellCheck manually
    - ACPI tables for fetching Windows the license embedded there
        - It mentions use of C, however, it seems like it may be possible to just use shell: https://osxdaily.com/2018/09/09/how-find-windows-product-key
    - Port to Python?
        - This seems like it would only add unnecessary LOC to scripts like create-media.sh where the Python script would essentially just be calling losetup/udisksctl and genisoimage
        - This would be suitable for qvm-create-windows-qube.sh though
    - Not mentioned on GSoC listing; but would probably have to port install.sh to SaltStack
        - As others have mentioned, SaltStack is not beginner friendly so some help here would be appreciated
- [ ] Put this todo list into GitHub issues
